---
import '../styles/global.css';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';

interface Props {
  title?: string;
  description?: string;
}

const {
  title = 'catdev - Cloud-Native DevOps & DevSecOps Specialist',
  description = 'Production-grade delivery platforms for SaaS teams. We build, secure, and operate cloud-native infrastructureâ€”Kubernetes, Terraform, CI/CD pipelines, and software supply chain security.'
} = Astro.props;

const GA_ID = 'G-4TDGDGK41V';
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content={description} />
    <meta name="generator" content={Astro.generator} />

    <!-- Favicon -->
    <link rel="icon" type="image/png" href="/favicon.png" />

    <!-- Open Graph -->
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:type" content="website" />
    <meta property="og:image" content="/og-image.png" />

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description} />

    <title>{title}</title>

    <!-- Google Analytics - Only loaded after consent -->
    <script define:vars={{ GA_ID }}>
      window.GA_ID = GA_ID;
    </script>
  </head>
  <body class="overflow-x-hidden">
    <Header />
    <main>
      <slot />
    </main>
    <Footer />

    <!-- Cookie Consent Banner -->
    <div id="cookie-consent" class="fixed bottom-0 left-0 right-0 z-50 p-4 transform translate-y-full transition-transform duration-300">
      <div class="max-w-4xl mx-auto">
        <div class="bg-deep-space border border-white/10 rounded-2xl p-4 md:p-6 shadow-2xl backdrop-blur-xl">
          <div class="flex flex-col md:flex-row md:items-center gap-4">
            <div class="flex-1">
              <p class="text-white text-sm font-medium mb-1">We value your privacy</p>
              <p class="text-steel text-xs leading-relaxed">
                We use cookies to analyze site traffic and improve your experience. By clicking "Accept", you consent to our use of analytics cookies.
              </p>
            </div>
            <div class="flex gap-3 flex-shrink-0">
              <button id="cookie-decline" class="px-4 py-2 text-xs font-medium text-steel hover:text-white border border-white/10 rounded-lg transition-colors">
                Decline
              </button>
              <button id="cookie-accept" class="px-4 py-2 text-xs font-medium bg-cyan text-midnight rounded-lg hover:bg-cyan/90 transition-colors">
                Accept
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Cookie consent and Google Analytics management with geo-awareness
      const CONSENT_KEY = 'catdev_cookie_consent';
      const GEO_KEY = 'catdev_user_geo';
      const consentBanner = document.getElementById('cookie-consent');
      const acceptBtn = document.getElementById('cookie-accept');
      const declineBtn = document.getElementById('cookie-decline');

      // Countries requiring explicit consent (EU/EEA + UK + Brazil)
      const CONSENT_REQUIRED_COUNTRIES = [
        'AT', 'BE', 'BG', 'HR', 'CY', 'CZ', 'DK', 'EE', 'FI', 'FR',
        'DE', 'GR', 'HU', 'IE', 'IT', 'LV', 'LT', 'LU', 'MT', 'NL',
        'PL', 'PT', 'RO', 'SK', 'SI', 'ES', 'SE', // EU
        'IS', 'LI', 'NO', // EEA
        'GB', // UK
        'BR'  // Brazil
      ];

      // Check for existing consent
      function getConsent(): string | null {
        return localStorage.getItem(CONSENT_KEY);
      }

      // Get cached geo or null
      function getCachedGeo(): string | null {
        return localStorage.getItem(GEO_KEY);
      }

      // Load Google Analytics
      function loadGA() {
        const GA_ID = (window as any).GA_ID;
        if (!GA_ID) return;

        // Load gtag.js
        const script = document.createElement('script');
        script.async = true;
        script.src = `https://www.googletagmanager.com/gtag/js?id=${GA_ID}`;
        document.head.appendChild(script);

        // Initialize gtag
        (window as any).dataLayer = (window as any).dataLayer || [];
        function gtag(...args: any[]) {
          (window as any).dataLayer.push(args);
        }
        (window as any).gtag = gtag;
        gtag('js', new Date());
        gtag('config', GA_ID, {
          anonymize_ip: true,
          cookie_flags: 'SameSite=None;Secure'
        });
      }

      // Show consent banner
      function showBanner() {
        setTimeout(() => {
          consentBanner?.classList.remove('translate-y-full');
          consentBanner?.classList.add('translate-y-0');
        }, 1000);
      }

      // Hide consent banner
      function hideBanner() {
        consentBanner?.classList.add('translate-y-full');
        consentBanner?.classList.remove('translate-y-0');
      }

      // Handle consent
      function handleConsent(accepted: boolean) {
        localStorage.setItem(CONSENT_KEY, accepted ? 'accepted' : 'declined');
        hideBanner();
        if (accepted) {
          loadGA();
        }
      }

      // Check if consent is required based on country
      function requiresConsent(countryCode: string): boolean {
        return CONSENT_REQUIRED_COUNTRIES.includes(countryCode.toUpperCase());
      }

      // Detect user's country and handle consent flow
      async function detectGeoAndInitialize() {
        const consent = getConsent();

        // If user already made a choice, respect it
        if (consent === 'accepted') {
          loadGA();
          return;
        }
        if (consent === 'declined') {
          return;
        }

        // Check cached geo first
        let country = getCachedGeo();

        if (!country) {
          try {
            // Use ipapi.co free tier (1000 req/day, no API key needed)
            const response = await fetch('https://ipapi.co/country/', {
              signal: AbortSignal.timeout(3000)
            });
            if (response.ok) {
              country = await response.text();
              localStorage.setItem(GEO_KEY, country);
            }
          } catch {
            // On error, default to requiring consent (safer)
            country = null;
          }
        }

        // If we couldn't detect or consent is required, show banner
        if (!country || requiresConsent(country)) {
          showBanner();
        } else {
          // No consent required, load GA directly
          loadGA();
        }
      }

      // Initialize
      detectGeoAndInitialize();

      // Event listeners
      acceptBtn?.addEventListener('click', () => handleConsent(true));
      declineBtn?.addEventListener('click', () => handleConsent(false));
    </script>

    <script>
      // Scroll reveal animation
      const reveals = document.querySelectorAll('.reveal');

      const revealOnScroll = () => {
        reveals.forEach(element => {
          const windowHeight = window.innerHeight;
          const elementTop = element.getBoundingClientRect().top;
          const elementVisible = 150;

          if (elementTop < windowHeight - elementVisible) {
            element.classList.add('active');
          }
        });
      };

      window.addEventListener('scroll', revealOnScroll);
      revealOnScroll(); // Initial check

      // Smooth scroll for anchor links
      document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener('click', function (e) {
          e.preventDefault();
          const target = document.querySelector(this.getAttribute('href'));
          if (target) {
            target.scrollIntoView({ behavior: 'smooth', block: 'start' });
          }
        });
      });
    </script>
  </body>
</html>
